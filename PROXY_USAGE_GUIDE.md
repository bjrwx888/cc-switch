# 代理模式使用指南

CC-Switch 提供了两种代理模式，用于记录和统计 AI 模型的使用情况。

## 代理模式对比

### 接管模式（推荐）

**特点**：
- ✅ 自动配置，无需手动修改 API 地址
- ✅ 支持热切换供应商，无需重启应用
- ✅ 自动管理 Token，安全方便
- ✅ 适合日常使用

**工作原理**：
1. 自动备份 Claude/Codex/Gemini 的配置文件
2. 自动修改应用配置，将 API 地址指向代理服务器（http://127.0.0.1:15721）
3. 代理服务器自动注入正确的 Token 和转发请求
4. 记录所有请求的使用统计数据
5. 关闭时自动恢复原始配置

**使用步骤**：
1. 在主界面点击 "Proxy" 开关
2. 选择 "接管模式（推荐）"
3. 等待启动完成（图标变为绿色 ⚡）
4. 正常使用 Claude/Codex/Gemini，所有使用数据会自动记录
5. 查看"使用统计"页面了解使用情况

### 监控模式

**特点**：
- ✅ 灵活性高，不修改应用配置
- ✅ 适合高级用户自定义配置
- ⚠️ 需要手动配置每个应用的 API 地址

**工作原理**：
1. 启动代理服务器在后台监听（http://127.0.0.1:15721）
2. 不修改应用的配置文件
3. 用户需要手动配置各应用的 API 地址指向代理，并填写真实上游的 API Key
4. 代理不会替换/清空你填的 Key，不会自动切换上游；更换上游或 Key 需你手动改值
5. 记录通过代理的所有请求

**使用步骤**：

1. **启动监控模式**
   - 在主界面点击 "Proxy" 开关
   - 选择 "监控模式"
   - 等待启动完成（图标变为蓝色 📡）

2. **配置 Claude Code**
   - 打开 Claude Code 设置（~/.claude/settings.json）
   - 修改环境变量：
     ```json
     {
       "env": {
         "ANTHROPIC_BASE_URL": "http://127.0.0.1:15721",
        "ANTHROPIC_AUTH_TOKEN": "你的真实上游密钥"
        }
      }
      ```
   - 重启 Claude Code
   - 说明：Key 会随请求一起发送到你指定的上游，代理不会替换或自动切换其他上游

3. **配置 Codex**
   - 打开 Codex 设置（~/.codex/settings.json）
   - 修改配置：
     ```json
     {
       "auth": {
         "OPENAI_BASE_URL": "http://127.0.0.1:15721",
        "OPENAI_API_KEY": "你的真实上游密钥"
        }
      }
      ```
   - 重启 Codex
   - 说明：Key 保持你填的值，如需更换上游或 Key，手动修改此字段

4. **配置 Gemini CLI**
   - 打开 Gemini 设置（~/.gemini/config.json）
   - 修改环境变量：
     ```json
     {
       "env": {
         "GEMINI_API_BASE": "http://127.0.0.1:15721",
        "GOOGLE_API_KEY": "你的真实上游密钥"
        }
      }
      ```
   - 重启 Gemini CLI
   - 说明：代理不替换 Key，也不会自动切换到其他上游

5. **验证配置**
   - 使用各个应用发送请求
   - 在"使用统计"页面查看是否有数据记录

## 使用统计功能

无论使用哪种代理模式，都可以在"使用统计"页面查看：

- **总体统计**：请求总数、总成本、Token 使用量
- **趋势图表**：按时间查看使用趋势（24小时/7天/30天）
- **Provider 统计**：各供应商的使用情况和成本
- **模型统计**：各模型的使用分布
- **请求日志**：详细的请求记录，包括输入/输出 Token、成本等

## 常见问题

### 1. 为什么统计页面没有数据？

确保代理服务已启动且处于运行状态：
- 接管模式：Proxy 图标应为绿色⚡
- 监控模式：Proxy 图标应为蓝色📡，且已手动配置 API 地址

### 2. 接管模式下如何切换供应商？

接管模式支持热切换，只需：
1. 在供应商列表中点击其他供应商的"启用"按钮
2. 立即生效，无需重启应用
3. 启用按钮显示为绿色，表示接管模式下的热切换

### 3. 监控模式和接管模式可以同时使用吗？

不可以，一次只能使用一种模式。如果需要切换模式：
1. 先关闭当前代理
2. 重新开启并选择目标模式

### 4. 关闭接管模式会影响我的配置吗？

不会。接管模式会：
- 启动时自动备份原始配置
- 关闭时自动恢复原始配置
- 保证配置文件的安全性

### 5. 统计数据保存在哪里？

所有统计数据保存在本地 SQLite 数据库中（~/.cc-switch/cc-switch.db），不会上传到任何服务器。

## 技术细节

### 代理服务器

- 监听地址：127.0.0.1（仅本地访问）
- 默认端口：15721
- 支持的 API：
  - Claude API：`/v1/messages`
  - Codex (OpenAI) API：`/v1/chat/completions`, `/v1/responses`
  - Gemini API：`/v1beta/*`

### 数据安全

- Token 存储在本地加密数据库
- 代理服务器仅监听本地回环地址
- 不收集或上传任何使用数据
- 支持完全离线使用

## 支持

如有问题或建议，请访问项目 GitHub 仓库提交 Issue。
